<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Diamond AI – Query Console</title>
<style>
    body {
        background: #f5f7fa;
        font-family: Arial, sans-serif;
        padding: 20px;
    }
    #chatWindow {
        height: 60vh;
        overflow-y: auto;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .msg {
        margin: 10px 0;
        padding: 10px 14px;
        border-radius: 8px;
        max-width: 70%;
        white-space: pre-wrap;
    }
    .user {
        background: #0b74ff;
        color: #fff;
        margin-left: auto;
    }
    .bot {
        background: #e9ecef;
        color: #000;
        margin-right: auto;
    }
    #inputArea {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
    #userInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 15px;
    }
    #sendBtn {
        padding: 12px 20px;
        background: #0b74ff;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
    }
    #previewBox {
        display: none;
        margin-top: 20px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
        max-height: 260px;
        overflow-y: auto;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
    }
    th, td {
        border: 1px solid #ccc;
        padding: 6px 8px;
    }
    th {
        background: #f0f0f0;
        font-weight: bold;
    }
</style>

<!-- Markdown Renderer -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>
<body>

<h2>Diamond AI — Database Assistant</h2>

<div id="chatWindow"></div>

<div id="inputArea">
    <input id="userInput" placeholder="Ask something about the Diamond DB...">
    <button id="sendBtn">Send</button>
</div>

<div id="previewBox">
    <h3> Excel Preview</h3>
    <div id="downloadLink"></div>
    <div id="previewTable"></div>
</div>

<script>
const ws = new WebSocket("ws://localhost:8001/ws/query");
const chat = document.getElementById("chatWindow");

function addMsg(text, cls="bot", isMarkdown=false) {
    const el = document.createElement("div");
    el.className = "msg " + cls;
    el.innerHTML = isMarkdown ? marked.parse(text) : text;
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
}

ws.onopen = () => addMsg(" Connected to server", "bot");
ws.onclose = () => addMsg(" Disconnected", "bot");
ws.onerror = () => addMsg(" Connection error", "bot");

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "status") {
        addMsg(" " + msg.message, "bot");
    }
    else if (msg.type === "answer") {
        addMsg(msg.message, "bot", true);
    }
    else if (msg.type === "file") {
        addMsg(" Excel ready: " + msg.filename, "bot");
        document.getElementById("downloadLink").innerHTML = `
            <a href="${msg.url}" target="_blank"> Download Excel</a>
        `;
        document.getElementById("previewBox").style.display = "block";
    }
    else if (msg.type === "file_preview") {
        showPreviewTable(msg.preview_rows);
    }
};

function showPreviewTable(rows) {
    const wrap = document.getElementById("previewTable");
    if (!rows || rows.length === 0) {
        wrap.innerHTML = "<i>No preview available</i>";
        return;
    }
    const cols = Object.keys(rows[0]);
    let html = "<table><thead><tr>";
    cols.forEach(col => html += `<th>${col}</th>`);
    html += "</tr></thead><tbody>";
    rows.forEach(r => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
        html += "</tr>";
    });
    html += "</tbody></table>";
    wrap.innerHTML = html;
}

document.getElementById("sendBtn").onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;
    addMsg(text, "user");
    ws.send(JSON.stringify({ question: text }));
    userInput.value = "";
};

document.getElementById("userInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("sendBtn").click();
});
</script>

</body>
</html>
