<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Diamond AI – Query Console</title>

<style>
    body {
        background: #f2f5f9;
        font-family: "Inter", Arial, sans-serif;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    header {
        padding: 15px 25px;
        background: white;
        font-size: 20px;
        font-weight: 700;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #chatWindow {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        background: #f7f9fc;
    }

    .msg {
        margin: 14px 0;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 75%;
        white-space: pre-wrap;
        line-height: 1.4;
        font-size: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .user {
        background: #0078ff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 2px;
    }

    .bot {
        background: white;
        color: #222;
        margin-right: auto;
        border-bottom-left-radius: 2px;
        border: 1px solid #e2e2e2;
    }

    #inputArea {
        padding: 15px;
        background: white;
        display: flex;
        gap: 10px;
        border-top: 1px solid #ddd;
    }

    #userInput {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ccc;
        outline: none;
        font-size: 15px;
    }

    #sendBtn {
        padding: 12px 22px;
        background: #0078ff;
        border: none;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
    }

    #sendBtn:hover {
        background: #005fcc;
    }

    #previewBox {
        display: none;
        background: white;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
        margin: 15px;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 6px 8px;
    }

    th {
        background: #f0f0f0;
        font-weight: bold;
    }

    #directDownloadBtn {
        padding: 10px 18px;
        background: #00a36f;
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        cursor: pointer;
        margin-bottom: 10px;
    }

    #directDownloadBtn:hover {
        background: #008a5d;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>

<header>Diamond AI — Database Assistant</header>

<div id="chatWindow"></div>

<div id="previewBox">
    <button id="directDownloadBtn">Download File</button>
    <div id="previewTable"></div>
</div>

<div id="inputArea">
    <input id="userInput" placeholder="Ask anything about Diamond DB…">
    <button id="sendBtn">Send</button>
</div>

<script>
const ws = new WebSocket("ws://localhost:8001/ws/query");
const chat = document.getElementById("chatWindow");

function addMsg(text, cls="bot", markdown=false) {
    const el = document.createElement("div");
    el.className = "msg " + cls;
    el.innerHTML = markdown ? marked.parse(text) : text;
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
}

ws.onopen = () => addMsg("Connected to server.", "bot");
ws.onclose = () => addMsg("Disconnected.", "bot");
ws.onerror = () => addMsg("Connection error occurred.", "bot");

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "status") {
        addMsg(msg.message, "bot");
    }

    else if (msg.type === "answer") {
        addMsg(msg.message, "bot", true);
    }

    else if (msg.type === "file") {
        const fileUrl = msg.url;
        const fileName = msg.filename;

        document.getElementById("previewBox").style.display = "block";

        // Auto-download on button click
        document.getElementById("directDownloadBtn").onclick = () => {
            const a = document.createElement("a");
            a.href = fileUrl;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
        };
    }

    else if (msg.type === "file_preview") {
        showPreviewTable(msg.preview_rows);
    }
};

function showPreviewTable(rows) {
    const wrap = document.getElementById("previewTable");
    if (!rows || rows.length === 0) {
        wrap.innerHTML = "<i>No preview available.</i>";
        return;
    }

    const cols = Object.keys(rows[0]);
    let html = "<table><thead><tr>";
    cols.forEach(c => html += `<th>${c}</th>`);
    html += "</tr></thead><tbody>";

    rows.forEach(r => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${r[c] ?? ""}</td>`);
        html += "</tr>";
    });

    html += "</tbody></table>";
    wrap.innerHTML = html;
}

document.getElementById("sendBtn").onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;

    addMsg(text, "user");
    ws.send(JSON.stringify({ question: text }));
    userInput.value = "";
};

document.getElementById("userInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("sendBtn").click();
});
</script>

</body>
</html>
